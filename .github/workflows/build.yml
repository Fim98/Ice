#
#  build.yml
#  Ice
#

name: Build and Release

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'  # Push tags like v1.0.0 to trigger release
  pull_request:
    branches: [main]
  release:
    types: [created, published]

jobs:
  build:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Build Debug
        run: |
          xcodebuild -project Ice.xcodeproj -scheme Ice -configuration Debug build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            DEVELOPMENT_TEAM=""

      - name: Build Release
        run: |
          xcodebuild -project Ice.xcodeproj -scheme Ice -configuration Release archive -archivePath build/Ice.xcarchive \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            DEVELOPMENT_TEAM=""

      - name: Export App
        run: |
          # Copy the app from the archive for distribution
          cp -R build/Ice.xcarchive/Products/Applications/Ice.app build/Ice.app

      - name: Ad-hoc Sign (for testing)
        run: |
          codesign --force --deep --sign - build/Ice.app

      - name: Create ZIP
        run: |
          ditto -c -k --keepParent build/Ice.app Ice.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Ice
          path: Ice.zip

      - name: Upload to Release
        if: github.event_name == 'release' || startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: Ice.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
